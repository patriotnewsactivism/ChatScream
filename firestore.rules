rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- HELPER FUNCTIONS ---

    function isSignedIn() {
      return request.auth != null;
    }

    function requesterEmail() {
      return isSignedIn() ? request.auth.token.email : null;
    }

    function isMaster() {
      return isSignedIn() && requesterEmail() == 'mreardon@wtpnews.org';
    }

    function isAdmin() {
      return isSignedIn() && (isMaster() || request.auth.token.role == 'admin');
    }

    // Rate limiting helper - checks if user has made too many writes recently
    function withinRateLimit(collection, maxPerHour) {
      return true; // Rate limiting implemented at Cloud Function level
    }

    // Validate string field
    function isValidString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }

    // Validate email format (basic)
    function isValidEmail(email) {
      return email is string && email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }

    // Sanitize check - no script tags or dangerous patterns
    function isSafeString(value) {
      return value is string
        && !value.lower().matches('.*<script.*')
        && !value.lower().matches('.*javascript:.*')
        && !value.lower().matches('.*on\\w+=.*');
    }

    // --- ADMIN CONFIG ---

    match /config/access {
      allow read, write: if isMaster();
    }

    match /config/oauth {
      allow read: if true;
      allow write: if isMaster();
    }

    match /config/{configId} {
      allow read: if isAdmin();
      allow write: if isMaster();
    }

    // --- USERS COLLECTION ---

    match /users/{userId} {
      // Users can read their own profile; admins can read any
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Users can create their own profile after sign-up
      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.email is string
        && (!('displayName' in request.resource.data) || isSafeString(request.resource.data.displayName));

      // Users can update limited profile fields
      allow update: if isSignedIn() && (
        (
          request.auth.uid == userId
          && !request.resource.data.diff(resource.data).affectedKeys().hasAny([
            'role',
            'betaTester',
            'subscription',
            'subscription.plan',
            'subscription.status',
            'subscription.trialEndsAt',
            'subscription.currentPeriodEnd',
            'subscription.stripeCustomerId',
            'subscription.stripeSubscriptionId',
            'subscription.betaOverride',
            'connectedPlatforms',
          ])
          // Ensure updated fields are safe
          && (!('displayName' in request.resource.data) || isSafeString(request.resource.data.displayName))
          && (!('bio' in request.resource.data) || isSafeString(request.resource.data.bio))
        )
        || (
          isAdmin()
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
            'role',
            'betaTester',
            'subscription',
            'subscription.plan',
            'subscription.status',
            'subscription.trialEndsAt',
            'subscription.currentPeriodEnd',
            'subscription.betaOverride',
          ])
        )
      );

      allow delete: if false;
    }

    // --- AFFILIATES COLLECTION ---

    match /affiliates/{affiliateId} {
      allow read: if true;

      allow create: if isSignedIn()
        && (isMaster() || request.resource.data.ownerId == request.auth.uid)
        && isValidString(request.resource.data.code, 3, 20)
        && affiliateId == request.resource.data.code
        && request.resource.data.isActive is bool
        && isSafeString(request.resource.data.code);

      allow update: if isSignedIn()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalReferrals'])
        && request.resource.data.totalReferrals is int
        && request.resource.data.totalReferrals == resource.data.totalReferrals + 1;

      allow delete: if isMaster();
    }

    // --- REFERRALS COLLECTION ---

    match /referrals/{referralId} {
      allow create: if isSignedIn()
        && isValidString(request.resource.data.affiliateCode, 3, 20)
        && request.resource.data.referrerId is string
        && request.resource.data.referredUserId == request.auth.uid;

      allow read: if isSignedIn() && (isAdmin() || resource.data.referrerId == request.auth.uid);
      allow update, delete: if false;
    }

    // --- SCREAMS (DONATIONS) COLLECTION ---

    match /screams/{screamId} {
      // Streamers can read their own screams
      allow read: if isSignedIn()
        && (resource.data.streamerId == request.auth.uid || isAdmin());

      // Only Cloud Functions can create (via webhook)
      allow create, update, delete: if false;
    }

    // --- STRIPE EVENTS (DEDUPLICATION) ---

    match /stripe_events/{eventId} {
      allow read, write: if false;
    }

    // --- SCREAM ALERTS ---

    match /scream_alerts/{alertId} {
      allow read: if isSignedIn() && resource.data.streamerId == request.auth.uid;
      allow create, update, delete: if false;
    }

    // --- SCREAM LEADERBOARD ---

    match /scream_leaderboard/{weekId} {
      allow read: if true;
      allow write: if false;

      match /entries/{entryId} {
        allow read: if true;
        allow write: if false;
      }
    }

    // --- STREAM SESSIONS (ANALYTICS) ---

    match /stream_sessions/{sessionId} {
      allow read: if isSignedIn()
        && (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.layout, 1, 50)
        && (!('platforms' in request.resource.data) || request.resource.data.platforms is list);

      // Allow updating only specific fields (for ending session)
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
          'endedAt', 'duration', 'peakViewers', 'status'
        ]);

      allow delete: if false;
    }

    // --- NOTIFICATIONS ---

    match /notifications/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if false; // Only Cloud Functions
      allow update: if isSignedIn()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // --- COMMISSION & PARTNER DATA (ADMIN ONLY) ---

    match /affiliate_commissions/{commissionId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    match /partners/{partnerId} {
      allow read: if isAdmin();
      allow write: if isMaster();
    }

    // --- ERROR LOGS (FOR DEBUGGING) ---

    match /error_logs/{logId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.message, 1, 2000);
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // --- FEEDBACK ---

    match /feedback/{feedbackId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.message, 10, 5000)
        && isSafeString(request.resource.data.message);
      allow read: if isAdmin();
      allow update, delete: if false;
    }
  }
}
